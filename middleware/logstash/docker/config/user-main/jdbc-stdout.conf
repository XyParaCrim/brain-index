input {
  jdbc {
    jdbc_connection_string => "${JDBC_CONNECT_STRING}"
    jdbc_user => "${JDBC_USER}"
    jdbc_password => "${JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_HOME}/lib/mysql-connector-java/mysql-connector-java-5.1.48-bin.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"
    jdbc_paging_enabled => true
    jdbc_page_size => "50000"

    schedule => "0 */5 * * * *"

    statement_filepath => "${LOGSTASH_CONFIG}/user-main/jdbc-input.sql"

    # 同步点文件，这个文件记录了上次的同步点，重启时会读取这个文件，这个文件可以手动修改
    last_run_metadata_path => "${LOGSTASH_LAST_RUN}/user-main"
  }
}
filter {
  jdbc_static {
    loaders => [
      {
        id => "wm_acct_detail"
        query => "select acct_id, user_name from wm_acct_detail"
        local_table => "acct_detail"
      },
      {
        id => "wm_user"
        query => "select id, acct_id, domain_id, status from wm_user where acct_id is not null"
        local_table => "acct_user"
      },
      {
        id => "wm_user_domain_relation"
        query => "select user_id, acct_id, domain_id, status from wm_user_domain_relation where acct_id is not null"
        local_table => "user_domain_relation"
      },
      {
        id => "wm_user_connect_purpose"
        query => "select id, acct_id, connect_purpose_name_low from wm_user_connect_purpose where acct_id is not null"
        local_table => "user_connect_purpose"
      },
      {
        id => "wm_user_job_area"
        query => "select id, acct_id, job_area_name_low from wm_user_job_area where acct_id is not null"
        local_table => "user_job_area"
      },
      {
        id => "wm_user_job_skill"
        query => "select id, acct_id, job_skill_name_low from wm_user_job_skill where acct_id is not null"
        local_table => "user_job_skill"
      },
      {
        id => "wm_user_job_role"
        query => "select id, acct_id, job_role_name_low from wm_user_job_role where acct_id is not null"
        local_table => "user_job_role"
      },
      {
        id => "wm_user_job_trade"
        query => "select id, acct_id, job_trade_name_low from wm_user_job_trade where acct_id is not null"
        local_table => "user_job_trade"
      }
    ]

    local_db_objects => [
      {
        name => "acct_detail"
        index_columns => ["acct_id"]
        columns => [
          ["acct_id", "bigint"],
          ["user_name", "varchar(255)"]
        ]
        preserve_existing => true
      },
      {
        name => "acct_user"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["domain_id", "varchar(50)"],
          ["status", "varchar(50)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_domain_relation"
        index_columns => ["user_id", "domain_id"]
        columns => [
            ["user_id", "bigint"],
            ["acct_id", "bigint"],
            ["domain_id", "varchar(50)"],
            ["status", "varchar(50)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_connect_purpose"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["connect_purpose_name", "varchar(150)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_job_area"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["job_area_name_low", "varchar(150)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_job_skill"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["job_skill_name_low", "varchar(150)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_job_role"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["job_role_name_low", "varchar(150)"]
        ]
        preserve_existing => true
      },
      {
        name => "user_job_trade"
        index_columns => ["id"]
        columns => [
          ["id", "bigint"],
          ["acct_id", "bigint"],
          ["job_trade_name_low", "varchar(150)"]
        ]
        preserve_existing => true
      }
    ]

    local_lookups => [
      {
        id => "local_acct_detail"
        target => "acct_detail"
        query => "select user_name from acct_detail where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user"
        target => "user"
        query => "select id, domain_id, status from acct_user where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_domain_relation"
        target => "user_domain_relation"
        query => "select user_id, domain_id, status from user_domain_relation where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_connect_purpose"
        target => "user_connect_purpose"
        query => "select connect_purpose_name from user_connect_purpose where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_job_area"
        target => "user_job_area"
        query => "select job_area_name_low from user_job_area where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_job_skill"
        target => "user_job_skill"
        query => "select job_skill_name_low from user_job_skill where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_job_role"
        target => "user_job_role"
        query => "select job_role_name_low from user_job_role where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      },
      {
        id => "local_user_job_trade"
        target => "user_job_trade"
        query => "select job_trade_name_low from user_job_trade where acct_id = :acct_id"
        parameters => { "acct_id" => "[acct_id]" }
      }
    ]

    loader_schedule => "0 * * * *"


    # jdbc connect message
    jdbc_connection_string => "${JDBC_CONNECT_STRING}"
    jdbc_user => "${JDBC_USER}"
    jdbc_password => "${JDBC_PASSWORD}"
    jdbc_driver_library => "${LOGSTASH_HOME}/lib/mysql-connector-java/mysql-connector-java-5.1.48-bin.jar"
    jdbc_driver_class => "com.mysql.jdbc.Driver"

    staging_directory => "${LOGSTASH_HOME}/data/tmp/logstash/jdbc_static/import_data"
  }

  mutate {
      add_field => {
          "[@metadata][mode]" => "${LOGSTASH_RUN_MODE:debug}"
          "[@metadata][index]" => "user-main"
          "[@metadata][type]" => "content"
      }

      #remove_field => ["tags"]
  }
}
output {
  stdout { }
}